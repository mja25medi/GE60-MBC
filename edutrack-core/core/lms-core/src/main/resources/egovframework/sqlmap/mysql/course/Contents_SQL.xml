<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="egovframework.edutrack.modules.course.contents.service.impl.ContentsMapper">	


	<select id="selectUnitCd" resultType="String">
	    SELECT CONCAT('CNT',LPAD(nextval('SQ_CRS_SBJ_CNTS'),9,'0')) AS UNIT_CD 
	</select>
	
	<sql id="selectContentsQuery">
		<![CDATA[
		  SELECT A.SBJ_CD  
		       , A.UNIT_CD  
		       , A.PAR_UNIT_CD  
		       , A.UNIT_NM  
		       , A.UNIT_LVL  
		       , A.UNIT_ODR  
		       , A.UNIT_TYPE  
		       , A.CNTS_TYPE_CD  
		       , A.UNIT_FILE_PATH  
		       , A.QUIZ_CNT  
		       , A.QUIZ_PASS_SCORE  
		       , A.PRGR_CHK_TYPE  
		       , A.CRIT_TM  
		       , A.TOTAL_PAGE  
		       , A.PRGR_CHK_YN  
		       , A.ATCH_FILE_PATH  
		       , A.MOBILE_FILE_PATH  
		       , A.MOBILE_FILE_PATH_2  
		       , A.MOBILE_YN  
		       , A.OLC_YN  
		       , A.REG_NO  
		       , A.REG_DTTM  
		       , A.MOD_NO  
		       , A.MOD_DTTM  
		       , (SELECT FN_GET_USER_NAME(A.MOD_NO) ) MOD_NM  
		       , (SELECT FN_GET_USER_NAME(A.REG_NO) ) REG_NM  
		       , NVL(( SELECT UNIT_NM
		                 FROM tb_crs_sbj_cnts  
		                WHERE UNIT_CD = A.PAR_UNIT_CD),'ROOT') AS PAR_UNIT_NM  
		       , CASE WHEN (A.UNIT_LVL -1) < 0 THEN 0 ELSE (A.UNIT_LVL -1) END PAR_UNIT_LVL  
		       , ( SELECT MAX(UNIT_ODR)  
		             FROM tb_crs_sbj_cnts  
		            WHERE NVL((PAR_UNIT_CD),'1') = NVL((A.PAR_UNIT_CD),'1') AND SBJ_CD = A.SBJ_CD) AS MAX_ODR
		       , ( SELECT COUNT(*)  
		             FROM tb_crs_sbj_cnts  
		            WHERE PAR_UNIT_CD = A.UNIT_CD AND SBJ_CD = A.SBJ_CD) AS SUB_CNT  
		       , ( SELECT COUNT(*)  
		             FROM tb_lec_bookmark  
		            WHERE SBJ_CD = A.SBJ_CD  
		              AND UNIT_CD = A.UNIT_CD ) AS BOOKMARK_CNT  
		    FROM tb_crs_sbj_cnts A 
		   WHERE SBJ_CD = #{sbjCd}  
		]]>
	</sql>


 	<select id="listContentsDel" parameterType="contentsVO" resultType="contentsVO">
	    <include refid="selectContentsQuery" />
	    AND NVL((PAR_UNIT_CD),'1') = NVL((#{parUnitCd}) ,'1')
	    ORDER BY UNIT_ODR
	</select>
<!--	
 	<select id="listContents" parameterType="contentsVO" resultType="contentsVO">
	    <include refid="selectContentsQuery" />
	    AND NVL((PAR_UNIT_CD),'1') = NVL((#{parUnitCd}) ,'1')
	    ORDER BY UNIT_ODR
	</select>
 --> 
	<select id="listContents" parameterType="contentsVO" resultType="contentsVO">
		WITH RECURSIVE CTE AS
		(
			SELECT  
				  SBJ_CD
				, UNIT_CD
				, PAR_UNIT_CD
				, UNIT_NM
				, UNIT_LVL
				, UNIT_ODR
				, CRIT_TM
				, CONCAT(UNIT_ODR,'/',UNIT_CD) AS PATH
			FROM
				tb_crs_sbj_cnts
			WHERE
				UNIT_LVL = 1
			 AND SBJ_CD = #{sbjCd}
		UNION ALL
			SELECT  
				  A.SBJ_CD
				, A.UNIT_CD
				, A.PAR_UNIT_CD
				, A.UNIT_NM
				, A.UNIT_LVL
				, A.UNIT_ODR
				, A.CRIT_TM
				, CONCAT(CTE.path ,'/', A.UNIT_ODR) AS PATH
			FROM
				tb_crs_sbj_cnts AS A
			INNER JOIN 
				CTE ON A.PAR_UNIT_CD = CTE.UNIT_CD
		)
		SELECT * FROM CTE 
		ORDER BY PATH
	</select>
	
	<select id="listContentsVer5" parameterType="contentsVO" resultType="contentsVO">
		 SELECT a.SBJ_CD 
			 , a.UNIT_CD
		     , a.PAR_UNIT_CD
		     , a.UNIT_NM
		     , a.UNIT_LVL 
		     , a.UNIT_ODR 
		     , a.CRIT_TM 
		     , CONCAT_WS('>', b.UNIT_CD, a.UNIT_CD) PATH
		  FROM tb_crs_sbj_cnts a
		  LEFT OUTER JOIN tb_crs_sbj_cnts b ON a.PAR_UNIT_CD = b.UNIT_CD
		  where a.SBJ_CD = #{sbjCd}
		  ORDER BY PATH
	</select>
	
	<select id="parListContents" parameterType="contentsVO" resultType="contentsVO">
	    <include refid="selectContentsQuery" />
	    AND NVL((UNIT_CD),'1') = NVL((#{parUnitCd}) ,'1')
	    ORDER BY UNIT_ODR
	</select>	
		
	<select id="selectContents" parameterType="contentsVO" resultType="contentsVO">
	    <include refid="selectContentsQuery" />
	    <choose>
		    <when test = 'parUnitCd != null and parUnitCd != ""'>
				AND UNIT_CD = #{parUnitCd}
			</when>
			<otherwise>
				AND  NVL(UNIT_CD,'') = NVL(#{unitCd},'')
			</otherwise>	    
	    </choose>
	</select>

    <insert id="insertContents" parameterType="contentsVO">
		  INSERT INTO tb_crs_sbj_cnts (  
		         SBJ_CD  
		       , UNIT_CD  
		       , PAR_UNIT_CD  
		       , UNIT_NM  
		       , UNIT_LVL  
		       , UNIT_ODR  
		       , UNIT_TYPE  
		       , CNTS_TYPE_CD  
		       , UNIT_FILE_PATH  
		       , QUIZ_CNT  
		       , QUIZ_PASS_SCORE  
		       , PRGR_CHK_TYPE  
		       , CRIT_TM  
		       , TOTAL_PAGE  
		       , PRGR_CHK_YN  
		       , ATCH_FILE_PATH  
		       , MOBILE_FILE_PATH  
		       , MOBILE_FILE_PATH_2  
		       , MOBILE_YN  
		       , OLC_YN  
		       , REG_NO  
		       , REG_DTTM  
		       , MOD_NO  
		       , MOD_DTTM  
		  ) VALUES (  
		         #{sbjCd}  
			   , #{unitCd}
		       , #{parUnitCd}  
		       , #{unitNm}  
		       , #{unitLvl}  
		       , ( SELECT NVL((MAX(UNIT_ODR)) ,0)+1
		             FROM tb_crs_sbj_cnts AS SUBQUERY
		            WHERE SBJ_CD = #{sbjCd}  
		              AND NVL((PAR_UNIT_CD),'1') = NVL((#{parUnitCd}),'1') )
		       , #{unitType}  
		       , #{cntsTypeCd}  
		       , #{unitFilePath}  
		       , #{quizCnt}  
		       , #{quizPassScore}  
		       , #{prgrChkType}  
		       , #{critTm}  
		       , #{totalPage}  
		       , #{prgrChkYn}  
		       , #{atchFilePath}  
		       , #{mobileFilePath}  
		       , #{mobileFilePath2}  
		       , #{mobileYn}  
		       , #{olcYn}  
		       , #{regNo}  
		       ,DATE_FORMAT(NOW(), '%Y%m%d%H%i%s')
		       , #{modNo}  
		       ,DATE_FORMAT(NOW(), '%Y%m%d%H%i%s')
		  )  
    </insert>
 	<insert id="insertContentsBatch" parameterType="list" >
		  INSERT INTO tb_crs_sbj_cnts (  
		         SBJ_CD  
		       , UNIT_CD  
		       , PAR_UNIT_CD  
		       , UNIT_NM  
		       , UNIT_LVL  
		       , UNIT_ODR  
		       , UNIT_TYPE  
		       , CNTS_TYPE_CD  
		       , UNIT_FILE_PATH  
		       , QUIZ_CNT  
		       , QUIZ_PASS_SCORE  
		       , PRGR_CHK_TYPE  
		       , CRIT_TM  
		       , TOTAL_PAGE  
		       , PRGR_CHK_YN  
		       , ATCH_FILE_PATH  
		       , MOBILE_FILE_PATH  
		       , MOBILE_FILE_PATH_2  
		       , MOBILE_YN  
		       , OLC_YN  
		       , REG_NO  
		       , REG_DTTM  
		       , MOD_NO  
		       , MOD_DTTM  
		  ) 
		  VALUES 
		<foreach collection="list" item="item" index="index" separator=",">
			(  
		         #{item.sbjCd}  
			   , #{item.unitCd}
		       , #{item.parUnitCd }
		       , #{item.unitNm}  
		       , #{item.unitLvl } 
		       , ( SELECT NVL((MAX(UNIT_ODR)),0)+1  
		             FROM tb_crs_sbj_cnts AS SUBQUERY
		            WHERE SBJ_CD = #{item.sbjCd}  
		              AND NVL((PAR_UNIT_CD),'1') = NVL(#{item.parUnitCd}),'1') )
		       , #{item.unitType}  
		       , #{item.cntsTypeCd}  
		       , #{item.unitFilePath}  
		       , #{item.quizCnt}  
		       , #{item.quizPassScore}  
		       , #{item.prgrChkType}  
		       , #{item.critTm}  
		       , #{item.totalPage}  
		       , #{item.prgrChkYn}  
		       , #{item.atchFilePath}  
		       , #{item.mobileFilePath}  
		       , #{item.mobileFilePath2}  
		       , #{item.mobileYn}  
		       , #{item.olcYn}  
		       , #{item.regNo}  
		       ,DATE_FORMAT(NOW(), '%Y%m%d%H%i%s')
		       , #{item.modNo}  
		       ,DATE_FORMAT(NOW(), '%Y%m%d%H%i%s')
		  	)  		
		</foreach>
		;
	</insert>

   <update id="updateContents" parameterType="contentsVO">
		  UPDATE tb_crs_sbj_cnts  
		     SET UNIT_NM = #{unitNm}  
		       , PAR_UNIT_CD = NVL((#{parUnitCd}), PAR_UNIT_CD)
		       , UNIT_LVL = #{unitLvl}  
		       , UNIT_ODR = #{unitOdr}  
		       , UNIT_TYPE = #{unitType}  
		       , CNTS_TYPE_CD = #{cntsTypeCd}  
		       , UNIT_FILE_PATH	= #{unitFilePath}	  
		       , QUIZ_CNT = #{quizCnt}  
		       , QUIZ_PASS_SCORE = #{quizPassScore}  
		       , PRGR_CHK_TYPE = #{prgrChkType}  
		       , CRIT_TM = #{critTm}  
		       , TOTAL_PAGE = #{totalPage}
		       , PRGR_CHK_YN = (CASE WHEN #{prgrChkYn} ='Y' THEN 'Y' ELSE 'N' END)
		       , ATCH_FILE_PATH = #{atchFilePath}  
		       , MOBILE_FILE_PATH = #{mobileFilePath}  
		       , MOBILE_FILE_PATH_2 = #{mobileFilePath2}  
		       , MOBILE_YN = #{mobileYn}  
		       , OLC_YN	= #{olcYn}  
		       , MOD_NO = #{modNo}  
		       , REG_DTTM = DATE_FORMAT(NOW(), '%Y%m%d%H%i%s')
		   WHERE SBJ_CD = #{sbjCd}  
		     AND UNIT_CD = #{unitCd} 
    </update>
	<update id="updateContentsBatch" parameterType="list" >
		<foreach collection="list" item="item" index="index" separator=";">
		  UPDATE tb_crs_sbj_cnts  
		  SET
		         UNIT_NM = #{item.unitNm}  
		       , PAR_UNIT_CD = NVL((#{item.parUnitCd}), PAR_UNIT_CD)
		       , UNIT_LVL = #{item.unitLvl}  
		       , UNIT_ODR = #{item.unitOdr}  
		       , UNIT_TYPE = #{item.unitType}  
		       , CNTS_TYPE_CD = #{item.cntsTypeCd}  
		       , UNIT_FILE_PATH	= #{item.unitFilePath}	  
		       , QUIZ_CNT = #{item.quizCnt}  
		       , QUIZ_PASS_SCORE = #{item.quizPassScore}  
		       , PRGR_CHK_TYPE = #{item.prgrChkType}  
		       , CRIT_TM = #{item.critTm}  
		       , TOTAL_PAGE =#{item.totalPage}  
		       , PRGR_CHK_YN = (CASE WHEN #{item.prgrChkYn} = 'Y' THEN 'Y' ELSE 'N' END)
		       , ATCH_FILE_PATH = #{item.atchFilePath}  
		       , MOBILE_FILE_PATH = #{item.mobileFilePath}  
		       , MOBILE_FILE_PATH_2 = #{item.mobileFilePath2}  
		       , MOBILE_YN = #{item.mobileYn}  
		       , OLC_YN	= #{item.olcYn}  
		       , MOD_NO = #{item.modNo}  
		       , REG_DTTM = DATE_FORMAT(NOW(), '%Y%m%d%H%i%s')
		   WHERE SBJ_CD = #{item.sbjCd}  
		     AND UNIT_CD = #{item.unitCd} 
		</foreach>	     
	</update>
	
	<delete id="deleteContents" parameterType="contentsVO">
		 DELETE FROM tb_crs_sbj_cnts  
  		 WHERE SBJ_CD = #{sbjCd} 
     		AND UNIT_CD = #{unitCd}   
    </delete>

	<delete id="deleteAllContents" parameterType="string">
		 DELETE FROM tb_crs_sbj_cnts  
  		 WHERE SBJ_CD = #{value} 
    </delete>

	<select id="listSort" parameterType="ContentsVO" resultType="ContentsVO">
		WITH RECURSIVE CTE AS
		(
			SELECT  
				  SBJ_CD
				, UNIT_CD
				, PAR_UNIT_CD
				, UNIT_NM
				, UNIT_LVL
				, UNIT_ODR
				, CONCAT(UNIT_ODR,'/',UNIT_CD) AS PATH
			FROM
				tb_crs_sbj_cnts
			WHERE
				UNIT_LVL = 1
			 AND SBJ_CD = #{sbjCd}
		UNION ALL
			SELECT  
				  A.SBJ_CD
				, A.UNIT_CD
				, A.PAR_UNIT_CD
				, A.UNIT_NM
				, A.UNIT_LVL
				, A.UNIT_ODR
				, CONCAT(CTE.path ,'/', A.UNIT_ODR) AS PATH
			FROM
				tb_crs_sbj_cnts AS A
			INNER JOIN 
				CTE ON A.PAR_UNIT_CD = CTE.UNIT_CD
		)
		 	SELECT * 																					
		     FROM ( 																					
		<![CDATA[
		  SELECT A.SBJ_CD  
		       , A.UNIT_CD  
		       , A.PAR_UNIT_CD  
		       , A.UNIT_NM  
		       , A.UNIT_LVL  
		       , A.UNIT_ODR  
		       , A.UNIT_TYPE  
		       , A.CNTS_TYPE_CD  
		       , A.UNIT_FILE_PATH  
		       , A.QUIZ_CNT  
		       , A.QUIZ_PASS_SCORE  
		       , A.PRGR_CHK_TYPE  
		       , A.CRIT_TM  
		       , A.TOTAL_PAGE  
		       , A.PRGR_CHK_YN  
		       , A.ATCH_FILE_PATH  
		       , A.MOBILE_FILE_PATH  
		       , A.MOBILE_FILE_PATH_2  
		       , A.MOBILE_YN  
		       , A.OLC_YN  
		       , A.REG_NO  
		       , A.REG_DTTM  
		       , A.MOD_NO  
		       , A.MOD_DTTM  
		       , (SELECT FN_GET_USER_NAME(A.MOD_NO) ) MOD_NM  
		       , (SELECT FN_GET_USER_NAME(A.REG_NO) ) REG_NM  
		       , NVL(( SELECT UNIT_NM
		                 FROM tb_crs_sbj_cnts  
		                WHERE UNIT_CD = A.PAR_UNIT_CD),'ROOT') AS PAR_UNIT_NM  
		       , CASE WHEN (A.UNIT_LVL -1) < 0 THEN 0 ELSE (A.UNIT_LVL -1) END PAR_UNIT_LVL  
		       , ( SELECT MAX(UNIT_ODR)  
		             FROM tb_crs_sbj_cnts  
		            WHERE NVL((PAR_UNIT_CD),'1') = NVL((A.PAR_UNIT_CD),'1') AND SBJ_CD = A.SBJ_CD) AS MAX_ODR
		       , ( SELECT COUNT(*)  
		             FROM tb_crs_sbj_cnts  
		            WHERE PAR_UNIT_CD = A.UNIT_CD AND SBJ_CD = A.SBJ_CD) AS SUB_CNT  
		       , ( SELECT COUNT(*)  
		             FROM tb_lec_bookmark  
		            WHERE SBJ_CD = A.SBJ_CD  
		              AND UNIT_CD = A.UNIT_CD ) AS BOOKMARK_CNT  
		       , B.PATH
		    FROM tb_crs_sbj_cnts A, CTE AS B
		    WHERE A.SBJ_CD = B.SBJ_CD
		    AND A.UNIT_CD = B.UNIT_CD
		           ) T 																					
		  	 WHERE SUB_CNT > 0 
		  	ORDER BY PATH
		]]>
	</select>

	<select id="listSortVer5" parameterType="ContentsVO" resultType="ContentsVO">
		<![CDATA[
		select * from (
			 SELECT a.SBJ_CD  
			   , a.UNIT_CD  
			   , a.PAR_UNIT_CD  
			   , a.UNIT_NM  
			   , a.UNIT_LVL  
			   , a.UNIT_ODR  
			   , a.UNIT_TYPE  
			   , a.CNTS_TYPE_CD  
			   , a.UNIT_FILE_PATH  
			   , a.QUIZ_CNT  
			   , a.QUIZ_PASS_SCORE  
			   , a.PRGR_CHK_TYPE  
			   , a.CRIT_TM  
			   , a.TOTAL_PAGE  
			   , a.PRGR_CHK_YN  
			   , a.ATCH_FILE_PATH  
			   , a.MOBILE_FILE_PATH  
			   , a.MOBILE_FILE_PATH_2  
			   , a.MOBILE_YN  
			   , a.OLC_YN  
			   , a.REG_NO  
			   , a.REG_DTTM  
			   , a.MOD_NO  
			   , a.MOD_DTTM  
			   , (SELECT FN_GET_USER_NAME(a.MOD_NO) ) MOD_NM  
			   , (SELECT FN_GET_USER_NAME(a.REG_NO) ) REG_NM  
			   , NVL(( SELECT UNIT_NM
			             FROM tb_crs_sbj_cnts  
			            WHERE UNIT_CD = a.PAR_UNIT_CD),'ROOT') AS PAR_UNIT_NM  
			   , CASE WHEN (a.UNIT_LVL -1) < 0 THEN 0 ELSE (a.UNIT_LVL -1) END PAR_UNIT_LVL  
			   , ( SELECT MAX(UNIT_ODR)  
			         FROM tb_crs_sbj_cnts  
			        WHERE NVL((PAR_UNIT_CD),'1') = NVL((a.PAR_UNIT_CD),'1') AND SBJ_CD = a.SBJ_CD) AS MAX_ODR
			   , ( SELECT COUNT(*)  
			         FROM tb_crs_sbj_cnts  
			        WHERE PAR_UNIT_CD = a.UNIT_CD AND SBJ_CD = a.SBJ_CD) AS SUB_CNT  
			   , ( SELECT COUNT(*)  
			         FROM tb_lec_bookmark  
			        WHERE SBJ_CD = a.SBJ_CD  
			          AND UNIT_CD = a.UNIT_CD ) AS BOOKMARK_CNT
			     , CONCAT_WS('>', b.UNIT_CD, a.UNIT_CD) path
			  FROM tb_crs_sbj_cnts a
			  LEFT OUTER JOIN tb_crs_sbj_cnts b ON a.PAR_UNIT_CD = b.UNIT_CD
			  where a.SBJ_CD = #{sbjCd} 
			  ORDER BY path
			  ) T
			where T.SUB_CNT > 0
		]]>
	</select>
	
	<select id="listSub" parameterType="ContentsVO" resultType="ContentsVO">
	    <include refid="selectContentsQuery" />
	    AND NVL((PAR_UNIT_CD),'1') = NVL((#{parUnitCd}) ,'1')
	    ORDER BY UNIT_ODR
	</select>
	
	<update id="updateBatch" parameterType="list" >
		  <foreach collection="list" item="item" index="index" separator=";">
		  UPDATE  tb_crs_sbj_cnts 
		  SET
				  UNIT_ODR 		= #{item.unitOdr}								
		   WHERE  UNIT_CD 		= #{item.unitCd}
		</foreach>
	</update>
	
	<select id="countChildContents" parameterType="contentsVO" resultType="Integer">
	    SELECT COUNT(*) as totalPage FROM tb_crs_sbj_cnts TCSC  WHERE SBJ_CD = #{sbjCd} AND PAR_UNIT_CD = #{unitCd}
	</select>
</mapper>	